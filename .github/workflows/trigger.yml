name: Trigger External Repository

on:
  pull_request:
    branches: [develop, preview, main]
    types: [closed]

jobs:
  determine-environment:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event.pull_request.base.ref }}" == "main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.pull_request.base.ref }}" == "preview" ]; then
            echo "environment=preview" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.pull_request.base.ref }}" == "develop" ]; then
            echo "environment=develop" >> $GITHUB_OUTPUT
          else
            echo "environment=develop" >> $GITHUB_OUTPUT
          fi
          
      - name: Debug environment
        run: |
          echo "Determined environment: ${{ steps.env.outputs.environment }}"
          echo "Base ref: ${{ github.event.pull_request.base.ref }}"
          echo "Merged: ${{ github.event.pull_request.merged }}"
          
  trigger-external:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: 
      name: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Debug environment from previous job
        run: |
          echo "Environment from determine-environment job: ${{ needs.determine-environment.outputs.environment }}"
          
      - name: Trigger external repository
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.EXTERNAL_REPO_TOKEN || github.token }}
          repository: fabiosilvaonearth/${{ vars.EXTERNAL_REPO_NAME }}
          event-type: pr-merged
          client-payload: '{
            "source_branch": "${{ github.event.pull_request.head.ref }}",
            "target_branch": "${{ github.event.pull_request.base.ref }}",
            "environment": "${{ needs.determine-environment.outputs.environment }}",
            "source_repo": "${{ github.repository }}",
            "commit_sha": "${{ github.event.pull_request.merge_commit_sha }}",
            "pr_number": "${{ github.event.pull_request.number }}",
            "pr_title": "${{ github.event.pull_request.title }}"
            }'